ðŸ“Š PLAN DE IMPLEMENTACIÃ“N: MÃ“DULO DE CAJA

  ðŸŽ¯ OBJETIVOS

  1. GestiÃ³n de Cajas: Control de apertura/cierre de cajas por sucursal y usuario
  2. Movimientos de Efectivo: Registro de entradas/salidas de dinero
  3. Control Contable: Cuadre de caja, reportes financieros
  4. IntegraciÃ³n: Conectar con ventas, pagos, gastos y transferencias

  ---
  ðŸ“‹ ANÃLISIS DEL SISTEMA ACTUAL

  âœ… Lo que ya tienes:

  - âœ… Sistema de ventas con pagos (contado/crÃ©dito)
  - âœ… Modelo Payment para cuotas de crÃ©dito
  - âœ… MÃ©todos de pago: efectivo, tarjeta, transferencia, yape, plin
  - âœ… Multi-sucursal (Branch)
  - âœ… Multi-usuario con roles
  - âœ… Compras (PurchaseOrder)

  âŒ Lo que falta:

  - âŒ Control de caja (apertura/cierre)
  - âŒ Registro de gastos/egresos
  - âŒ Movimientos de efectivo
  - âŒ Arqueo de caja
  - âŒ Reportes financieros
  - âŒ Transferencias entre cajas

  ---
  ðŸ—„ï¸ FASE 1: DISEÃ‘O DE BASE DE DATOS

  Tabla: cash_registers (Cajas Registradoras)

  Schema::create('cash_registers', function (Blueprint $table) {
      $table->id();
      $table->string('name'); // "Caja Principal", "Caja 2"
      $table->foreignId('branch_id')->constrained()->onDelete('cascade');
      $table->enum('type', ['principal', 'secundaria'])->default('principal');
      $table->boolean('is_active')->default(true);
      $table->decimal('opening_balance', 12, 2)->default(0); // Fondo fijo inicial
      $table->text('description')->nullable();
      $table->timestamps();
      $table->softDeletes();
  });

  Tabla: cash_sessions (Sesiones de Caja - Apertura/Cierre)

  Schema::create('cash_sessions', function (Blueprint $table) {
      $table->id();
      $table->foreignId('cash_register_id')->constrained()->onDelete('cascade');
      $table->foreignId('user_id')->constrained(); // Usuario que abre/cierra
      $table->foreignId('branch_id')->constrained();

      // Apertura
      $table->dateTime('opened_at');
      $table->decimal('opening_balance', 12, 2); // Efectivo inicial
      $table->text('opening_notes')->nullable();

      // Cierre
      $table->dateTime('closed_at')->nullable();
      $table->decimal('expected_balance', 12, 2)->nullable(); // SegÃºn sistema
      $table->decimal('actual_balance', 12, 2)->nullable(); // Conteo fÃ­sico
      $table->decimal('difference', 12, 2)->nullable(); // Diferencia (sobrante/faltante)
      $table->text('closing_notes')->nullable();

      $table->enum('status', ['abierta', 'cerrada'])->default('abierta');
      $table->timestamps();

      $table->index(['cash_register_id', 'opened_at']);
      $table->index(['user_id', 'status']);
  });

  Tabla: cash_movements (Movimientos de Caja)

  Schema::create('cash_movements', function (Blueprint $table) {
      $table->id();
      $table->foreignId('cash_session_id')->constrained()->onDelete('cascade');
      $table->foreignId('cash_register_id')->constrained()->onDelete('cascade');
      $table->foreignId('user_id')->constrained(); // Usuario que registra
      $table->foreignId('branch_id')->constrained();

      $table->enum('type', [
          'ingreso',      // Entrada de dinero
          'egreso',       // Salida de dinero
          'venta',        // Ingreso por venta
          'pago_credito', // Ingreso por pago de cuota
          'compra',       // Egreso por compra
          'gasto',        // Egreso por gasto operativo
          'transferencia_entrada', // Transferencia desde otra caja
          'transferencia_salida',  // Transferencia hacia otra caja
          'ajuste'        // Ajuste manual
      ]);

      $table->decimal('amount', 12, 2);
      $table->enum('payment_method', ['efectivo', 'tarjeta', 'transferencia', 'yape', 'plin']);

      // Referencias opcionales
      $table->foreignId('sale_id')->nullable()->constrained()->onDelete('set null');
      $table->foreignId('payment_id')->nullable()->constrained('sale_payments')->onDelete('set null');
      $table->foreignId('purchase_order_id')->nullable()->constrained()->onDelete('set null');
      $table->foreignId('expense_id')->nullable()->constrained()->onDelete('set null');

      $table->string('reference_number')->nullable(); // NÃºmero de referencia
      $table->text('description');
      $table->text('notes')->nullable();

      $table->timestamps();

      $table->index(['cash_session_id', 'type']);
      $table->index(['created_at']);
  });

  Tabla: expenses (Gastos Operativos)

  Schema::create('expenses', function (Blueprint $table) {
      $table->id();
      $table->foreignId('branch_id')->constrained();
      $table->foreignId('expense_category_id')->constrained();
      $table->foreignId('user_id')->constrained(); // Usuario que registra
      $table->foreignId('cash_session_id')->nullable()->constrained()->onDelete('set null');

      $table->date('expense_date');
      $table->decimal('amount', 12, 2);
      $table->enum('payment_method', ['efectivo', 'tarjeta', 'transferencia']);

      $table->string('supplier_name')->nullable(); // Proveedor del servicio
      $table->string('document_type')->nullable(); // boleta, factura, recibo
      $table->string('document_number')->nullable();

      $table->text('description');
      $table->text('notes')->nullable();
      $table->string('receipt_file')->nullable(); // Archivo adjunto

      $table->enum('status', ['pendiente', 'aprobado', 'rechazado'])->default('pendiente');
      $table->timestamps();
      $table->softDeletes();

      $table->index(['expense_date']);
      $table->index(['expense_category_id']);
  });

  Tabla: expense_categories (CategorÃ­as de Gastos)

  Schema::create('expense_categories', function (Blueprint $table) {
      $table->id();
      $table->string('name'); // "Servicios", "Sueldos", "Alquiler", etc.
      $table->text('description')->nullable();
      $table->string('color')->default('#6b7280'); // Para UI
      $table->boolean('is_active')->default(true);
      $table->timestamps();
  });

  Tabla: cash_transfers (Transferencias entre Cajas)

  Schema::create('cash_transfers', function (Blueprint $table) {
      $table->id();
      $table->foreignId('from_cash_register_id')->constrained('cash_registers');
      $table->foreignId('to_cash_register_id')->constrained('cash_registers');
      $table->foreignId('from_branch_id')->constrained('branches');
      $table->foreignId('to_branch_id')->constrained('branches');
      $table->foreignId('user_id')->constrained(); // Usuario que realiza

      $table->dateTime('transfer_date');
      $table->decimal('amount', 12, 2);
      $table->text('description');
      $table->text('notes')->nullable();

      $table->enum('status', ['pendiente', 'completada', 'cancelada'])->default('pendiente');
      $table->timestamps();
  });

  ---
  ðŸ—ï¸ FASE 2: MODELOS Y LÃ“GICA DE NEGOCIO

  Modelo: CashRegister

  class CashRegister extends Model
  {
      public function branch() // RelaciÃ³n con sucursal
      public function sessions() // Sesiones de caja
      public function movements() // Movimientos
      public function currentSession() // SesiÃ³n activa actual
      public function isOpen() // Â¿EstÃ¡ abierta?
  }

  Modelo: CashSession

  class CashSession extends Model
  {
      public function cashRegister()
      public function user()
      public function movements()

      // MÃ©todos de negocio
      public function open($openingBalance, $notes)
      public function close($actualBalance, $notes)
      public function calculateExpectedBalance()
      public function getDifference()
      public function getSalesTotal()
      public function getExpensesTotal()
      public function getIncomesTotal()
      public function getEgressesTotal()
  }

  Modelo: CashMovement

  class CashMovement extends Model
  {
      public function cashSession()
      public function cashRegister()
      public function user()
      public function sale()
      public function payment()
      public function expense()

      // MÃ©todos
      public static function recordSale($sale, $cashSession)
      public static function recordPayment($payment, $cashSession)
      public static function recordExpense($expense, $cashSession)
      public static function recordIncome($amount, $description, $cashSession)
      public static function recordEgress($amount, $description, $cashSession)
  }

  Modelo: Expense

  class Expense extends Model
  {
      public function category()
      public function branch()
      public function user()
      public function cashSession()

      public function approve()
      public function reject()
  }

  ---
  ðŸ”„ FASE 3: INTEGRACIÃ“N CON SISTEMA EXISTENTE

  1. Modificar SaleController::store()

  DespuÃ©s de crear la venta, registrar movimiento en caja:

  // DespuÃ©s de crear la venta
  if ($sale->payment_type === 'contado') {
      // Obtener sesiÃ³n de caja abierta del usuario
      $cashSession = CashSession::where('user_id', auth()->id())
          ->where('status', 'abierta')
          ->latest()
          ->first();

      if ($cashSession) {
          CashMovement::recordSale($sale, $cashSession);
      }
  }

  2. Modificar Payment::markAsPaid()

  Registrar movimiento cuando se paga una cuota:

  public function markAsPaid($paymentMethod, $transactionReference = null, $notes = null): void
  {
      // ... cÃ³digo existente ...

      // Registrar en caja si es efectivo
      if ($paymentMethod === 'efectivo') {
          $cashSession = CashSession::getCurrentUserSession();
          if ($cashSession) {
              CashMovement::recordPayment($this, $cashSession);
          }
      }
  }

  ---
  ðŸ“± FASE 4: VISTAS Y FUNCIONALIDAD

  Vistas a Crear:

  1. /cash/dashboard - Dashboard de caja
    - Estado actual de cajas
    - SesiÃ³n activa
    - Resumen del dÃ­a
  2. /cash/open - Abrir caja
    - Seleccionar caja
    - Ingresar saldo inicial
    - Notas de apertura
  3. /cash/movements - Movimientos
    - Lista de movimientos del dÃ­a
    - Filtros por tipo
    - Agregar ingreso/egreso manual
  4. /cash/close - Cerrar caja
    - Resumen de movimientos
    - Conteo de efectivo
    - Arqueo y diferencia
  5. /cash/sessions - Historial de sesiones
    - Lista de sesiones cerradas
    - Reportes de cuadre
  6. /expenses - Gastos
    - Registrar gastos
    - Aprobar/rechazar gastos
    - CategorÃ­as de gastos
  7. /cash/reports - Reportes
    - Flujo de caja
    - Ingresos vs Egresos
    - Comparativas por perÃ­odo

  ---
  ðŸŽ¯ FASE 5: IMPLEMENTACIÃ“N POR PASOS

  PASO 1: Base de Datos (Semana 1)

  âœ… Crear migraciones
  âœ… Crear seeders para categorÃ­as de gastos
  âœ… Ejecutar migraciones

  PASO 2: Modelos y Relaciones (Semana 1-2)

  âœ… Crear modelos
  âœ… Definir relaciones
  âœ… Crear mÃ©todos de negocio

  PASO 3: Apertura/Cierre de Caja (Semana 2)

  âœ… Controller: CashSessionController
  âœ… Vista: Abrir caja
  âœ… Vista: Cerrar caja
  âœ… LÃ³gica de cuadre

  PASO 4: Movimientos AutomÃ¡ticos (Semana 3)

  âœ… Integrar con ventas
  âœ… Integrar con pagos
  âœ… Middleware para verificar caja abierta

  PASO 5: Gastos (Semana 3-4)

  âœ… CRUD de gastos
  âœ… CategorÃ­as de gastos
  âœ… AprobaciÃ³n de gastos

  PASO 6: Movimientos Manuales (Semana 4)

  âœ… Ingresos manuales
  âœ… Egresos manuales
  âœ… Transferencias entre cajas

  PASO 7: Reportes (Semana 5)

  âœ… Dashboard de caja
  âœ… Reportes financieros
  âœ… ExportaciÃ³n PDF/Excel

  ---
  ðŸ’¡ REGLAS DE NEGOCIO IMPORTANTES

  1. Solo una sesiÃ³n abierta por usuario/caja
  2. Validar caja abierta antes de crear ventas en efectivo
  3. Registrar automÃ¡ticamente movimientos de ventas/pagos
  4. Gastos requieren aprobaciÃ³n (opcional)
  5. Arqueo de caja obligatorio al cierre
  6. HistÃ³rico inmutable de sesiones cerradas

  ---
  ðŸ“Š BENEFICIOS DEL MÃ“DULO

  âœ… Control financiero completo
  âœ… Trazabilidad de todo el dinero
  âœ… DetecciÃ³n de diferencias (faltantes/sobrantes)
  âœ… Reportes contables precisos
  âœ… Cumplimiento de normativas
  âœ… AuditorÃ­a facilitada

  ---
  Â¿Quieres que empiece a implementar este plan? Â¿Por cuÃ¡l fase prefieres comenzar?